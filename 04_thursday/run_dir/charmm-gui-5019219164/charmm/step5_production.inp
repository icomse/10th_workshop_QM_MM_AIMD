* GENERATED BY CHARMM-GUI (http://www.charmm-gui.org) v3.7 on Jun, 17. 2025. JOBID=5019219164
* INPUT FILE FOR NVT DYNAMICS OF SOLVATED GLOBULAR PROTEIN
*

DIMENS CHSIZE 5000000 MAXRES 3000000

! Read topology and parameter files
stream toppar.str

read rtf  card append name qm_regroup.top
read para card append name qm_params.prm flex

bomlev -1
! Please set cnt on the command line like this: $charmm cnt=$cnt -i step5_production.inp -o step5_production_${cnt}.out
if @?cnt .eq. 0 stop  ! Error: missing value for cnt

! Read PSF
open read unit 10 card name step4.1_qmmm.psf
read psf  unit 10 card

! Read Coordinate
open read unit 10 card name step4.1_qmmm.crd
read coor unit 10 card

!
! Setup PBC (Periodic Boundary Condition)
!

stream step3_pbcsetup.str

!
! Image Setup
!

open read unit 10 card name crystal_image.str
CRYSTAL DEFINE @XTLtype @A @B @C @alpha @beta @gamma
CRYSTAL READ UNIT 10 CARD


!Image centering by residue
IMAGE BYRESID XCEN @xcen YCEN @ycen ZCEN @zcen sele resname TIP3 end
IMAGE BYRESID XCEN @xcen YCEN @ycen ZCEN @zcen sele segid IONS end

!
! Nonbonded Options
!

NBONds -
   NBXMod 5 E14Fac 1.0 WMIN 1.0 -
   ELEC GROUp SWITch EWALd KAPPa 0.34 SPLIne PMEWald ORDEr 6 -
   FFTX 64 FFTY 64 FFTZ 64 -
   CDIE EPS 1.0 -
   VDW VGROup VSWItch -
   CUTNb 16.0 CTOFnb 12.0 CTONnb 10.0 INBF -1 IMGFrq -1 CUTIm 16.0

!
!use a restraint to place center of mass of the molecules near the origin
!

MMFP
GEO rcm sphere -
    Xref @xcen Yref @ycen Zref @zcen XDIR 1.0 YDIR 1.0 ZDIR 1.0 -
    harmonic FORCE 1.0 select .not. ( hydrogen .or. resname TIP3 .or. segid IONS ) end
END

!
! NVT dynamics:
! you can change
! nstep  : number of MD steps
! nprint : print-out frequency
! nsavc  : the trajectory saving frequency
!


set temp = 300
set qmpackage = sccdftb
stream qm_region.str
faster 2
shake bonh sele .not. ( QMS .or. type QQH* ) end param fast

update imal imgf -1
scalar WMAIN set 1.0 sele QMS .and. type N*  show end
scalar WMAIN set 2.0 sele QMS .and. type C*  show end
scalar WMAIN set 3.0 sele QMS .and. type O*  show end
scalar WMAIN set 4.0 sele QMS .and. type H*  show end

sccdftb remove charge 1 sele ( QMS .or. type QQH* ) end SCFT 0.00000001 -
pmew fftx @fftx ffty @fftx fftz @fftx order 6 endif
energy

open write unit 10 card name step5_@cnt_before_mini.pdb
write coor unit 10 pdb

! Short minimization
mini abnr nstep 100

open write unit 10 card name step5_@cnt_after_mini.pdb
write coor unit 10 pdb

calc pcnt = @cnt - 1
if pcnt .eq. 0 then
   set mdst start
   set iread -11
endif
if pcnt .gt. 0 then
   open read  unit 11 card name step5_@pcnt.rst
   set mdst restart
   set iread 11
endif
open write unit 12 card name step5_@cnt.rst
open write unit 13 file name step5_@cnt.dcd

dynamics leap cpt @mdst -
         nstep 10000 timestep 0.001 -
         iunrea @iread iunwri 12 iuncrd 13 iunvel -1 kunit -1 -
         nprint 10 nsavc 10 isvfrq 10 ntrf 10 ixtfrq 10 iprfrq 10 -
         firstt @temp finalt @temp tstruc @temp -
         teminc 0.00 ihtfrq 0 ieqfrq 0 iasor 0 iasvel 1 iscvel 0 -
         ichecw 0 twindh 5.0 twindl -5.0  -
         hoover tmass 1000.0 reft @temp -
         pconstant pinternal pmass @Pmass preferencce 1.0 ECHECK 1000000.0

open write unit 10 card name step5_@cnt.pdb
write coor unit 10 pdb
close unit 10

open write unit 10 card name step5_@cnt.crd
write coor unit 10 card
close unit 10

stop
